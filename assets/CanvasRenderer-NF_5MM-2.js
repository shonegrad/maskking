import{p as yt,q as Zt,c as b,s as Dt,x as Bt,y as te,e as L,z as ee,V as ne,i as et,k as W,v as U,D as F,f as Q,o as G,A as At,H as ot,M as O,w as se,d as Ht,J as ae,K as re,L as oe,h as ie,F as ce,N as le,O as he,Q as de}from"./index-CPhNSrhm.js";import{c as ue,R as pe,S as fe,B as ge,a as me,b as xe,d as Ce,A as ye,C as _e}from"./RenderTargetSystem-Cx8emeQW.js";class ve{constructor(){this.isBatchable=!1}reset(){this.isBatchable=!1,this.context=null,this.graphicsData&&(this.graphicsData.destroy(),this.graphicsData=null)}destroy(){this.reset()}}class be{constructor(){this.instructions=new Zt}init(){this.instructions.reset()}destroy(){this.instructions.destroy(),this.instructions=null}}const _t=class Ct{constructor(t){this._renderer=t,this._managedContexts=new yt({renderer:t,type:"resource",name:"graphicsContext"})}init(t){Ct.defaultOptions.bezierSmoothness=t?.bezierSmoothness??Ct.defaultOptions.bezierSmoothness}getContextRenderData(t){return this.getGpuContext(t).graphicsData||this._initContextRenderData(t)}updateGpuContext(t){const e=t._gpuData,s=!!e[this._renderer.uid],n=e[this._renderer.uid]||this._initContext(t);return(t.dirty||!s)&&(s&&n.reset(),n.isBatchable=!1,t.dirty=!1),n}getGpuContext(t){return t._gpuData[this._renderer.uid]||this._initContext(t)}_initContextRenderData(t){const e=new be,s=this.getGpuContext(t);return s.graphicsData=e,e.init(),e}_initContext(t){const e=new ve;return e.context=t,t._gpuData[this._renderer.uid]=e,this._managedContexts.add(t),e}destroy(){this._managedContexts.destroy(),this._renderer=null}};_t.extension={type:[b.CanvasSystem],name:"graphicsContext"};_t.defaultOptions={bezierSmoothness:.5};let Te=_t;class Wt{constructor(t,e){this.state=Dt.for2d(),this.renderer=t,this._adaptor=e,this.renderer.runners.contextChange.add(this),this._managedGraphics=new yt({renderer:t,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(t){return!1}addRenderable(t,e){this._managedGraphics.add(t),this.renderer.renderPipes.batch.break(e),e.add(t)}updateRenderable(t){}execute(t){t.isRenderable&&this._adaptor.execute(this,t)}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null}}Wt.extension={type:[b.CanvasPipes],name:"graphics"};class Me{constructor(){this.batches=[],this.batched=!1}destroy(){this.batches.forEach(t=>{Bt.return(t)}),this.batches.length=0}}class Ut{constructor(t,e){this.state=Dt.for2d(),this.renderer=t,this._adaptor=e,this.renderer.runners.contextChange.add(this),this._managedGraphics=new yt({renderer:t,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(t){const e=t.context,s=!!t._gpuData,a=this.renderer.graphicsContext.updateGpuContext(e);return!!(a.isBatchable||s!==a.isBatchable)}addRenderable(t,e){const n=this.renderer.graphicsContext.updateGpuContext(t.context);t.didViewUpdate&&this._rebuild(t),n.isBatchable?this._addToBatcher(t,e):(this.renderer.renderPipes.batch.break(e),e.add(t))}updateRenderable(t){const s=this._getGpuDataForRenderable(t).batches;for(let n=0;n<s.length;n++){const a=s[n];a._batcher.updateElement(a)}}execute(t){if(!t.isRenderable)return;const e=this.renderer,s=t.context;if(!e.graphicsContext.getGpuContext(s).batches.length)return;const a=s.customShader||this._adaptor.shader;this.state.blendMode=t.groupBlendMode;const o=a.resources.localUniforms.uniforms;o.uTransformMatrix=t.groupTransform,o.uRound=e._roundPixels|t._roundPixels,ue(t.groupColorAlpha,o.uColor,0),this._adaptor.execute(this,t)}_rebuild(t){const e=this._getGpuDataForRenderable(t),n=this.renderer.graphicsContext.updateGpuContext(t.context);e.destroy(),n.isBatchable&&this._updateBatchesForRenderable(t,e)}_addToBatcher(t,e){const s=this.renderer.renderPipes.batch,n=this._getGpuDataForRenderable(t).batches;for(let a=0;a<n.length;a++){const o=n[a];s.addToBatch(o,e)}}_getGpuDataForRenderable(t){return t._gpuData[this.renderer.uid]||this._initGpuDataForRenderable(t)}_initGpuDataForRenderable(t){const e=new Me;return t._gpuData[this.renderer.uid]=e,this._managedGraphics.add(t),e}_updateBatchesForRenderable(t,e){const s=t.context,a=this.renderer.graphicsContext.getGpuContext(s),o=this.renderer._roundPixels|t._roundPixels;e.batches=a.batches.map(i=>{const c=Bt.get(te);return i.copyTo(c),c.renderable=t,c.roundPixels=o,c})}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null}}Ut.extension={type:[b.WebGLPipes,b.WebGPUPipes],name:"graphics"};L.add(Wt);L.add(Ut);L.add(Te);L.add(ee);class ct extends ne{constructor(t){t instanceof et&&(t={context:t});const{context:e,roundPixels:s,...n}=t||{};super({label:"Graphics",...n}),this.renderPipeId="graphics",e?this.context=e:(this.context=this._ownedContext=new et,this.context.autoGarbageCollect=this.autoGarbageCollect),this.didViewUpdate=!0,this.allowChildren=!1,this.roundPixels=s??!1}set context(t){t!==this._context&&(this._context&&(this._context.off("update",this.onViewUpdate,this),this._context.off("unload",this.unload,this)),this._context=t,this._context.on("update",this.onViewUpdate,this),this._context.on("unload",this.unload,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}updateBounds(){}containsPoint(t){return this._context.containsPoint(t)}destroy(t){this._ownedContext&&!t?this._ownedContext.destroy(t):(t===!0||t?.context===!0)&&this._context.destroy(t),this._ownedContext=null,this._context=null,super.destroy(t)}_onTouch(t){this._gcLastUsed=t,this._context._gcLastUsed=t}_callContextMethod(t,e){return this.context[t](...e),this}setFillStyle(...t){return this._callContextMethod("setFillStyle",t)}setStrokeStyle(...t){return this._callContextMethod("setStrokeStyle",t)}fill(...t){return this._callContextMethod("fill",t)}stroke(...t){return this._callContextMethod("stroke",t)}texture(...t){return this._callContextMethod("texture",t)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...t){return this._callContextMethod("arc",t)}arcTo(...t){return this._callContextMethod("arcTo",t)}arcToSvg(...t){return this._callContextMethod("arcToSvg",t)}bezierCurveTo(...t){return this._callContextMethod("bezierCurveTo",t)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...t){return this._callContextMethod("ellipse",t)}circle(...t){return this._callContextMethod("circle",t)}path(...t){return this._callContextMethod("path",t)}lineTo(...t){return this._callContextMethod("lineTo",t)}moveTo(...t){return this._callContextMethod("moveTo",t)}quadraticCurveTo(...t){return this._callContextMethod("quadraticCurveTo",t)}rect(...t){return this._callContextMethod("rect",t)}roundRect(...t){return this._callContextMethod("roundRect",t)}poly(...t){return this._callContextMethod("poly",t)}regularPoly(...t){return this._callContextMethod("regularPoly",t)}roundPoly(...t){return this._callContextMethod("roundPoly",t)}roundShape(...t){return this._callContextMethod("roundShape",t)}filletRect(...t){return this._callContextMethod("filletRect",t)}chamferRect(...t){return this._callContextMethod("chamferRect",t)}star(...t){return this._callContextMethod("star",t)}svg(...t){return this._callContextMethod("svg",t)}restore(...t){return this._callContextMethod("restore",t)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...t){return this._callContextMethod("rotate",t)}scaleTransform(...t){return this._callContextMethod("scale",t)}setTransform(...t){return this._callContextMethod("setTransform",t)}transform(...t){return this._callContextMethod("transform",t)}translateTransform(...t){return this._callContextMethod("translate",t)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(t){this._context.fillStyle=t}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(t){this._context.strokeStyle=t}clone(t=!1){return t?new ct(this._context.clone()):(this._ownedContext=null,new ct(this._context))}lineStyle(t,e,s){W(U,"Graphics#lineStyle is no longer needed. Use Graphics#setStrokeStyle to set the stroke style.");const n={};return t&&(n.width=t),e&&(n.color=e),s&&(n.alpha=s),this.context.strokeStyle=n,this}beginFill(t,e){W(U,"Graphics#beginFill is no longer needed. Use Graphics#fill to fill the shape with the desired style.");const s={};return t!==void 0&&(s.color=t),e!==void 0&&(s.alpha=e),this.context.fillStyle=s,this}endFill(){W(U,"Graphics#endFill is no longer needed. Use Graphics#fill to fill the shape with the desired style."),this.context.fill();const t=this.context.strokeStyle;return(t.width!==et.defaultStrokeStyle.width||t.color!==et.defaultStrokeStyle.color||t.alpha!==et.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...t){return W(U,"Graphics#drawCircle has been renamed to Graphics#circle"),this._callContextMethod("circle",t)}drawEllipse(...t){return W(U,"Graphics#drawEllipse has been renamed to Graphics#ellipse"),this._callContextMethod("ellipse",t)}drawPolygon(...t){return W(U,"Graphics#drawPolygon has been renamed to Graphics#poly"),this._callContextMethod("poly",t)}drawRect(...t){return W(U,"Graphics#drawRect has been renamed to Graphics#rect"),this._callContextMethod("rect",t)}drawRoundedRect(...t){return W(U,"Graphics#drawRoundedRect has been renamed to Graphics#roundRect"),this._callContextMethod("roundRect",t)}drawStar(...t){return W(U,"Graphics#drawStar has been renamed to Graphics#star"),this._callContextMethod("star",t)}}let K;function Gt(r){const t=F.get().createCanvas(6,1),e=t.getContext("2d");return e.fillStyle=r,e.fillRect(0,0,6,1),t}function Ft(){if(K!==void 0)return K;try{const r=Gt("#ff00ff"),t=Gt("#ffff00"),s=F.get().createCanvas(6,1).getContext("2d");s.globalCompositeOperation="multiply",s.drawImage(r,0,0),s.drawImage(t,2,0);const n=s.getImageData(2,0,1,1);if(!n)K=!1;else{const a=n.data;K=a[0]===255&&a[1]===0&&a[2]===0}}catch{K=!1}return K}const d={canvas:null,convertTintToImage:!1,cacheStepsPerColorChannel:8,canUseMultiply:Ft(),tintMethod:null,_canvasSourceCache:new WeakMap,_unpremultipliedCache:new WeakMap,getCanvasSource:r=>{const t=r.source,e=t?.resource;if(!e)return null;const s=t.alphaMode==="premultiplied-alpha",n=t.resourceWidth??t.pixelWidth,a=t.resourceHeight??t.pixelHeight,o=n!==t.pixelWidth||a!==t.pixelHeight;if(s){if((e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas)&&!o)return e;const i=d._unpremultipliedCache.get(t);if(i?.resourceId===t._resourceId)return i.canvas}if(e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int8Array||e instanceof Uint16Array||e instanceof Int16Array||e instanceof Uint32Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof ArrayBuffer){const i=d._canvasSourceCache.get(t);if(i?.resourceId===t._resourceId)return i.canvas;const c=F.get().createCanvas(t.pixelWidth,t.pixelHeight),h=c.getContext("2d"),l=h.createImageData(t.pixelWidth,t.pixelHeight),p=l.data,m=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);if(t.format==="bgra8unorm")for(let x=0;x<p.length&&x+3<m.length;x+=4)p[x]=m[x+2],p[x+1]=m[x+1],p[x+2]=m[x],p[x+3]=m[x+3];else p.set(m.subarray(0,p.length));return h.putImageData(l,0,0),d._canvasSourceCache.set(t,{canvas:c,resourceId:t._resourceId}),c}if(s){const i=F.get().createCanvas(t.pixelWidth,t.pixelHeight),c=i.getContext("2d",{willReadFrequently:!0});i.width=t.pixelWidth,i.height=t.pixelHeight,c.drawImage(e,0,0);const h=c.getImageData(0,0,i.width,i.height),l=h.data;for(let p=0;p<l.length;p+=4){const m=l[p+3];if(m>0){const x=255/m;l[p]=Math.min(255,l[p]*x+.5),l[p+1]=Math.min(255,l[p+1]*x+.5),l[p+2]=Math.min(255,l[p+2]*x+.5)}}return c.putImageData(h,0,0),d._unpremultipliedCache.set(t,{canvas:i,resourceId:t._resourceId}),i}if(o){const i=d._canvasSourceCache.get(t);if(i?.resourceId===t._resourceId)return i.canvas;const c=F.get().createCanvas(t.pixelWidth,t.pixelHeight),h=c.getContext("2d");return c.width=t.pixelWidth,c.height=t.pixelHeight,h.drawImage(e,0,0),d._canvasSourceCache.set(t,{canvas:c,resourceId:t._resourceId}),c}return e},getTintedCanvas:(r,t)=>{const e=r.texture,s=Q.shared.setValue(t).toHex(),n=e.tintCache||(e.tintCache={}),a=n[s],o=e.source._resourceId;if(a?.tintId===o)return a;const i=a&&"getContext"in a?a:F.get().createCanvas();return d.tintMethod(e,t,i),i.tintId=o,n[s]=i,n[s]},getTintedPattern:(r,t)=>{const e=Q.shared.setValue(t).toHex(),s=r.patternCache||(r.patternCache={}),n=r.source._resourceId;let a=s[e];return a?.tintId===n||(d.canvas||(d.canvas=F.get().createCanvas()),d.tintMethod(r,t,d.canvas),a=d.canvas.getContext("2d").createPattern(d.canvas,"repeat"),a.tintId=n,s[e]=a),a},applyPatternTransform:(r,t,e=!0)=>{if(!t)return;const s=r;if(!s.setTransform)return;const n=globalThis.DOMMatrix;if(!n)return;const a=new n([t.a,t.b,t.c,t.d,t.tx,t.ty]);s.setTransform(e?a.inverse():a)},tintWithMultiply:(r,t,e)=>{const s=e.getContext("2d"),n=r.frame.clone(),a=r.source._resolution??r.source.resolution??1,o=r.rotate;n.x*=a,n.y*=a,n.width*=a,n.height*=a;const i=G.isVertical(o),c=i?n.height:n.width,h=i?n.width:n.height;e.width=Math.ceil(c),e.height=Math.ceil(h),s.save(),s.fillStyle=Q.shared.setValue(t).toHex(),s.fillRect(0,0,c,h),s.globalCompositeOperation="multiply";const l=d.getCanvasSource(r);if(!l){s.restore();return}o&&d._applyInverseRotation(s,o,n.width,n.height),s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.globalCompositeOperation="destination-atop",s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.restore()},tintWithOverlay:(r,t,e)=>{const s=e.getContext("2d"),n=r.frame.clone(),a=r.source._resolution??r.source.resolution??1,o=r.rotate;n.x*=a,n.y*=a,n.width*=a,n.height*=a;const i=G.isVertical(o),c=i?n.height:n.width,h=i?n.width:n.height;e.width=Math.ceil(c),e.height=Math.ceil(h),s.save(),s.globalCompositeOperation="copy",s.fillStyle=Q.shared.setValue(t).toHex(),s.fillRect(0,0,c,h),s.globalCompositeOperation="destination-atop";const l=d.getCanvasSource(r);if(!l){s.restore();return}o&&d._applyInverseRotation(s,o,n.width,n.height),s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.restore()},tintWithPerPixel:(r,t,e)=>{const s=e.getContext("2d"),n=r.frame.clone(),a=r.source._resolution??r.source.resolution??1,o=r.rotate;n.x*=a,n.y*=a,n.width*=a,n.height*=a;const i=G.isVertical(o),c=i?n.height:n.width,h=i?n.width:n.height;e.width=Math.ceil(c),e.height=Math.ceil(h),s.save(),s.globalCompositeOperation="copy";const l=d.getCanvasSource(r);if(!l){s.restore();return}o&&d._applyInverseRotation(s,o,n.width,n.height),s.drawImage(l,n.x,n.y,n.width,n.height,0,0,n.width,n.height),s.restore();const p=t>>16&255,m=t>>8&255,x=t&255,k=s.getImageData(0,0,c,h),v=k.data;for(let y=0;y<v.length;y+=4)v[y]=v[y]*p/255,v[y+1]=v[y+1]*m/255,v[y+2]=v[y+2]*x/255;s.putImageData(k,0,0)},_applyInverseRotation:(r,t,e,s)=>{const n=G.inv(t),a=G.uX(n),o=G.uY(n),i=G.vX(n),c=G.vY(n),h=-Math.min(0,a*e,i*s,a*e+i*s),l=-Math.min(0,o*e,c*s,o*e+c*s);r.transform(a,o,i,c,h,l)}};d.tintMethod=d.canUseMultiply?d.tintWithMultiply:d.tintWithPerPixel;const vt=class z{static _getPatternRepeat(t,e){const s=t&&t!=="clamp-to-edge",n=e&&e!=="clamp-to-edge";return s&&n?"repeat":s?"repeat-x":n?"repeat-y":"no-repeat"}start(t,e,s){}execute(t,e){const s=e.elements;if(!s||!s.length)return;const n=t.renderer,a=n.canvasContext,o=a.activeContext;for(let i=0;i<s.length;i++){const c=s[i];if(!c.packAsQuad)continue;const h=c,l=h.texture,p=l?d.getCanvasSource(l):null;if(!p)continue;const m=l.source.style,x=a.smoothProperty,k=m.scaleMode!=="nearest";o[x]!==k&&(o[x]=k),a.setBlendMode(e.blendMode);const v=n.globalUniforms.globalUniformData?.worldColor??4294967295,y=h.color,D=(v>>>24&255)/255,T=(y>>>24&255)/255,B=n.filter?.alphaMultiplier??1,q=D*T*B;if(q<=0)continue;o.globalAlpha=q;const nt=v&16777215,P=y&16777215,N=At(ot(P,nt)),A=l.frame,Z=m.addressModeU??m.addressMode,j=m.addressModeV??m.addressMode,g=z._getPatternRepeat(Z,j),C=l.source._resolution??l.source.resolution??1,_=h.renderable?.renderGroup?.isCachedAsTexture,E=A.x*C,X=A.y*C,w=A.width*C,V=A.height*C,M=h.bounds,I=n.renderTarget.renderTarget.isRoot,R=M.minX,tt=M.minY,Y=M.maxX-M.minX,H=M.maxY-M.minY,S=l.rotate,u=l.uvs,lt=Math.min(u.x0,u.x1,u.x2,u.x3,u.y0,u.y1,u.y2,u.y3),Jt=Math.max(u.x0,u.x1,u.x2,u.x3,u.y0,u.y1,u.y2,u.y3),bt=g!=="no-repeat"&&(lt<0||Jt>1),ht=S&&!(!bt&&(N!==16777215||S));ht?(z._tempPatternMatrix.copyFrom(h.transform),G.matrixAppendRotationInv(z._tempPatternMatrix,S,R,tt,Y,H),a.setContextTransform(z._tempPatternMatrix,h.roundPixels===1,void 0,_&&I)):a.setContextTransform(h.transform,h.roundPixels===1,void 0,_&&I);const st=ht?0:R,at=ht?0:tt,dt=Y,ut=H;if(bt){let pt=p;const $=N!==16777215&&!S,J=A.width<=l.source.width&&A.height<=l.source.height;$&&J&&(pt=d.getTintedCanvas({texture:l},N));const ft=o.createPattern(pt,g);if(!ft)continue;const Tt=dt,Mt=ut;if(Tt===0||Mt===0)continue;const St=1/Tt,Pt=1/Mt,wt=(u.x1-u.x0)*St,kt=(u.y1-u.y0)*St,It=(u.x3-u.x0)*Pt,Rt=(u.y3-u.y0)*Pt,Kt=u.x0-wt*st-It*at,Qt=u.y0-kt*st-Rt*at,gt=l.source.pixelWidth,mt=l.source.pixelHeight;z._tempPatternMatrix.set(wt*gt,kt*mt,It*gt,Rt*mt,Kt*gt,Qt*mt),d.applyPatternTransform(ft,z._tempPatternMatrix),o.fillStyle=ft,o.fillRect(st,at,dt,ut)}else{const $=N!==16777215||S?d.getTintedCanvas({texture:l},N):p,J=$!==p;o.drawImage($,J?0:E,J?0:X,J?$.width:w,J?$.height:V,st,at,dt,ut)}}}};vt._tempPatternMatrix=new O;vt.extension={type:[b.CanvasPipesAdaptor],name:"batch"};let Se=vt;class Ot{constructor(t){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=t}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(t,e,s){this._renderer.renderPipes.batch.break(s);const n=this._colorStack;n[this._colorStackIndex]=n[this._colorStackIndex-1]&t.mask;const a=this._colorStack[this._colorStackIndex];a!==this._currentColor&&(this._currentColor=a,s.add({renderPipeId:"colorMask",colorMask:a,canBundle:!1})),this._colorStackIndex++}pop(t,e,s){this._renderer.renderPipes.batch.break(s);const n=this._colorStack;this._colorStackIndex--;const a=n[this._colorStackIndex-1];a!==this._currentColor&&(this._currentColor=a,s.add({renderPipeId:"colorMask",colorMask:a,canBundle:!1}))}execute(t){}destroy(){this._renderer=null,this._colorStack=null}}Ot.extension={type:[b.CanvasPipes],name:"colorMask"};function Pe(r,t,e,s,n,a){a=Math.max(0,Math.min(a,Math.min(s,n)/2)),r.moveTo(t+a,e),r.lineTo(t+s-a,e),r.quadraticCurveTo(t+s,e,t+s,e+a),r.lineTo(t+s,e+n-a),r.quadraticCurveTo(t+s,e+n,t+s-a,e+n),r.lineTo(t+a,e+n),r.quadraticCurveTo(t,e+n,t,e+n-a),r.lineTo(t,e+a),r.quadraticCurveTo(t,e,t+a,e)}function Et(r,t){switch(t.type){case"rectangle":{const e=t;r.rect(e.x,e.y,e.width,e.height);break}case"roundedRectangle":{const e=t;Pe(r,e.x,e.y,e.width,e.height,e.radius);break}case"circle":{const e=t;r.moveTo(e.x+e.radius,e.y),r.arc(e.x,e.y,e.radius,0,Math.PI*2);break}case"ellipse":{const e=t;r.ellipse?(r.moveTo(e.x+e.halfWidth,e.y),r.ellipse(e.x,e.y,e.halfWidth,e.halfHeight,0,0,Math.PI*2)):(r.save(),r.translate(e.x,e.y),r.scale(e.halfWidth,e.halfHeight),r.moveTo(1,0),r.arc(0,0,1,0,Math.PI*2),r.restore());break}case"triangle":{const e=t;r.moveTo(e.x,e.y),r.lineTo(e.x2,e.y2),r.lineTo(e.x3,e.y3),r.closePath();break}default:{const e=t,s=e.points;if(!s?.length)break;r.moveTo(s[0],s[1]);for(let n=2;n<s.length;n+=2)r.lineTo(s[n],s[n+1]);e.closePath&&r.closePath();break}}}function we(r,t){if(!t?.length)return!1;for(let e=0;e<t.length;e++){const s=t[e];if(!s?.shape)continue;const n=s.transform,a=n&&!n.isIdentity();a&&(r.save(),r.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),Et(r,s.shape),a&&r.restore()}return!0}class Vt{constructor(t){this._warnedMaskTypes=new Set,this._canvasMaskStack=[],this._renderer=t}push(t,e,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:t,inverse:e._maskOptions.inverse,canBundle:!1})}pop(t,e,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"stencilMask",action:"popMaskEnd",mask:t,inverse:e._maskOptions.inverse,canBundle:!1})}execute(t){if(t.action!=="pushMaskBegin"&&t.action!=="popMaskEnd")return;const e=this._renderer,s=e.canvasContext,n=s?.activeContext;if(!n)return;if(t.action==="popMaskEnd"){this._canvasMaskStack.pop()&&n.restore();return}t.inverse&&this._warnOnce("inverse","CanvasRenderer: inverse masks are not supported on Canvas2D; ignoring inverse flag.");const a=t.mask.mask;if(!(a instanceof ct)){this._warnOnce("nonGraphics","CanvasRenderer: only Graphics masks are supported in Canvas2D; skipping mask."),this._canvasMaskStack.push(!1);return}const o=a,i=o.context?.instructions;if(!i?.length){this._canvasMaskStack.push(!1);return}n.save(),s.setContextTransform(o.groupTransform,(e._roundPixels|o._roundPixels)===1),n.beginPath();let c=!1,h=!1;for(let l=0;l<i.length;l++){const p=i[l],m=p.action;if(m!=="fill"&&m!=="stroke")continue;const k=p.data?.path?.shapePath;if(!k?.shapePrimitives?.length)continue;const v=k.shapePrimitives;for(let y=0;y<v.length;y++){const D=v[y];if(!D?.shape)continue;const T=D.transform,B=T&&!T.isIdentity();B&&(n.save(),n.transform(T.a,T.b,T.c,T.d,T.tx,T.ty)),Et(n,D.shape),h=we(n,D.holes)||h,c=!0,B&&n.restore()}}if(!c){n.restore(),this._canvasMaskStack.push(!1);return}h?n.clip("evenodd"):n.clip(),this._canvasMaskStack.push(!0)}destroy(){this._renderer=null,this._warnedMaskTypes=null,this._canvasMaskStack=null}_warnOnce(t,e){this._warnedMaskTypes.has(t)||(this._warnedMaskTypes.add(t),se(e))}}Vt.extension={type:[b.CanvasPipes],name:"stencilMask"};const f="source-over";function ke(){const r=Ft(),t=Object.create(null);return t.inherit=f,t.none=f,t.normal="source-over",t.add="lighter",t.multiply=r?"multiply":f,t.screen=r?"screen":f,t.overlay=r?"overlay":f,t.darken=r?"darken":f,t.lighten=r?"lighten":f,t["color-dodge"]=r?"color-dodge":f,t["color-burn"]=r?"color-burn":f,t["hard-light"]=r?"hard-light":f,t["soft-light"]=r?"soft-light":f,t.difference=r?"difference":f,t.exclusion=r?"exclusion":f,t.saturation=r?"saturation":f,t.color=r?"color":f,t.luminosity=r?"luminosity":f,t["linear-burn"]=r?"color-burn":f,t["linear-dodge"]=r?"color-dodge":f,t["linear-light"]=r?"hard-light":f,t["pin-light"]=r?"hard-light":f,t["vivid-light"]=r?"hard-light":f,t["hard-mix"]=f,t.negation=r?"difference":f,t["normal-npm"]=t.normal,t["add-npm"]=t.add,t["screen-npm"]=t.screen,t.erase="destination-out",t.subtract=f,t.divide=f,t.min=f,t.max=f,t}const Ie=new O;class Lt{constructor(t){this.activeResolution=1,this.smoothProperty="imageSmoothingEnabled",this.blendModes=ke(),this._activeBlendMode="normal",this._projTransform=null,this._outerBlend=!1,this._warnedBlendModes=new Set,this._renderer=t}resolutionChange(t){this.activeResolution=t}init(){const t=this._renderer.background.alpha<1;if(this.rootContext=this._renderer.canvas.getContext("2d",{alpha:t}),this.activeContext=this.rootContext,this.activeResolution=this._renderer.resolution,!this.rootContext.imageSmoothingEnabled){const e=this.rootContext;e.webkitImageSmoothingEnabled?this.smoothProperty="webkitImageSmoothingEnabled":e.mozImageSmoothingEnabled?this.smoothProperty="mozImageSmoothingEnabled":e.oImageSmoothingEnabled?this.smoothProperty="oImageSmoothingEnabled":e.msImageSmoothingEnabled&&(this.smoothProperty="msImageSmoothingEnabled")}}setContextTransform(t,e,s,n){const a=n?O.IDENTITY:this._renderer.globalUniforms.globalUniformData?.worldTransformMatrix||O.IDENTITY;let o=Ie;o.copyFrom(a),o.append(t);const i=this._projTransform,c=this.activeResolution;if(s=s||c,i){const h=O.shared;h.copyFrom(o),h.prepend(i),o=h}e?this.activeContext.setTransform(o.a*s,o.b*s,o.c*s,o.d*s,o.tx*c|0,o.ty*c|0):this.activeContext.setTransform(o.a*s,o.b*s,o.c*s,o.d*s,o.tx*c,o.ty*c)}clear(t,e){const s=this.activeContext,n=this._renderer;if(s.clearRect(0,0,n.width,n.height),t){const a=Q.shared.setValue(t);s.globalAlpha=e??a.alpha,s.fillStyle=a.toHex(),s.fillRect(0,0,n.width,n.height),s.globalAlpha=1}}setBlendMode(t){if(this._activeBlendMode===t)return;this._activeBlendMode=t,this._outerBlend=!1;const e=this.blendModes[t];if(!e){this._warnedBlendModes.has(t)||(console.warn(`CanvasRenderer: blend mode "${t}" is not supported in Canvas2D; falling back to "source-over".`),this._warnedBlendModes.add(t)),this.activeContext.globalCompositeOperation="source-over";return}this.activeContext.globalCompositeOperation=e}destroy(){this.rootContext=null,this.activeContext=null,this._warnedBlendModes.clear()}}Lt.extension={type:[b.CanvasSystem],name:"canvasContext"};class qt{constructor(){this.maxTextures=16,this.maxBatchableTextures=16,this.maxUniformBindings=0}init(){}}qt.extension={type:[b.CanvasSystem],name:"limits"};const Re="#808080",rt=new O,Ge=new O,De=new O,xt=new O;function Be(r,t,e){r.beginPath();for(let s=0;s<e.length;s+=3){const n=e[s]*2,a=e[s+1]*2,o=e[s+2]*2;r.moveTo(t[n],t[n+1]),r.lineTo(t[a],t[a+1]),r.lineTo(t[o],t[o+1]),r.closePath()}r.fill()}function Ae(r){return`#${(r&16777215).toString(16).padStart(6,"0")}`}function He(r,t,e,s,n,a){a=Math.max(0,Math.min(a,Math.min(s,n)/2)),r.moveTo(t+a,e),r.lineTo(t+s-a,e),r.quadraticCurveTo(t+s,e,t+s,e+a),r.lineTo(t+s,e+n-a),r.quadraticCurveTo(t+s,e+n,t+s-a,e+n),r.lineTo(t+a,e+n),r.quadraticCurveTo(t,e+n,t,e+n-a),r.lineTo(t,e+a),r.quadraticCurveTo(t,e,t+a,e)}function it(r,t){switch(t.type){case"rectangle":{const e=t;r.rect(e.x,e.y,e.width,e.height);break}case"roundedRectangle":{const e=t;He(r,e.x,e.y,e.width,e.height,e.radius);break}case"circle":{const e=t;r.arc(e.x,e.y,e.radius,0,Math.PI*2);break}case"ellipse":{const e=t;r.ellipse?r.ellipse(e.x,e.y,e.halfWidth,e.halfHeight,0,0,Math.PI*2):(r.save(),r.translate(e.x,e.y),r.scale(e.halfWidth,e.halfHeight),r.arc(0,0,1,0,Math.PI*2),r.restore());break}case"triangle":{const e=t;r.moveTo(e.x,e.y),r.lineTo(e.x2,e.y2),r.lineTo(e.x3,e.y3),r.closePath();break}default:{const e=t,s=e.points;if(!s?.length)break;r.moveTo(s[0],s[1]);for(let n=2;n<s.length;n+=2)r.lineTo(s[n],s[n+1]);e.closePath&&r.closePath();break}}}function We(r,t){if(!t?.length)return!1;for(let e=0;e<t.length;e++){const s=t[e];if(!s?.shape)continue;const n=s.transform,a=n&&!n.isIdentity();a&&(r.save(),r.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),it(r,s.shape),a&&r.restore()}return!0}function Ue(r,t,e,s){const n=r.fill;if(n instanceof ie){n.buildGradient();const o=n.texture;if(o){const i=d.getTintedPattern(o,t),c=e?xt.copyFrom(e).scale(o.source.pixelWidth,o.source.pixelHeight):xt.copyFrom(n.transform);return s&&!r.textureSpace&&c.append(s),d.applyPatternTransform(i,c),i}}if(n instanceof ce){const o=d.getTintedPattern(n.texture,t);return d.applyPatternTransform(o,n.transform),o}const a=r.texture;if(a&&a!==Ht.WHITE){if(!a.source.resource)return Re;const o=d.getTintedPattern(a,t),i=e?xt.copyFrom(e).scale(a.source.pixelWidth,a.source.pixelHeight):r.matrix;return d.applyPatternTransform(o,i),o}return Ae(t)}class Nt{constructor(){this.shader=null}contextChange(t){}execute(t,e){const s=t.renderer,n=s.canvasContext,a=n.activeContext,o=e.groupTransform,i=s.globalUniforms.globalUniformData?.worldColor??4294967295,c=e.groupColorAlpha,h=(i>>>24&255)/255,l=(c>>>24&255)/255,p=s.filter?.alphaMultiplier??1,m=h*l*p;if(m<=0)return;const x=i&16777215,k=c&16777215,v=At(ot(k,x)),y=s._roundPixels|e._roundPixels;a.save(),n.setContextTransform(o,y===1),n.setBlendMode(e.groupBlendMode);const D=e.context.instructions;for(let T=0;T<D.length;T++){const B=D[T];if(B.action==="texture"){const g=B.data,C=g.image,_=C?d.getCanvasSource(C):null;if(!_)continue;const E=g.alpha*m;if(E<=0)continue;const X=ot(g.style,v);a.globalAlpha=E;let w=_;X!==16777215&&(w=d.getTintedCanvas({texture:C},X));const V=C.frame,M=C.source._resolution??C.source.resolution??1;let I=V.x*M,R=V.y*M;const tt=V.width*M,Y=V.height*M;w!==_&&(I=0,R=0);const H=g.transform,S=H&&!H.isIdentity(),u=C.rotate;S||u?(rt.copyFrom(o),S&&rt.append(H),u&&G.matrixAppendRotationInv(rt,u,g.dx,g.dy,g.dw,g.dh),n.setContextTransform(rt,y===1)):n.setContextTransform(o,y===1),a.drawImage(w,I,R,w===_?tt:w.width,w===_?Y:w.height,u?0:g.dx,u?0:g.dy,g.dw,g.dh),(S||u)&&n.setContextTransform(o,y===1);continue}const q=B.data,nt=q?.path?.shapePath;if(!nt?.shapePrimitives?.length)continue;const P=q.style,N=ot(P.color,v),A=P.alpha*m;if(A<=0)continue;const Z=B.action==="stroke";if(a.globalAlpha=A,Z){const g=P;a.lineWidth=g.width,a.lineCap=g.cap,a.lineJoin=g.join,a.miterLimit=g.miterLimit}const j=nt.shapePrimitives;if(!Z&&q.hole?.shapePath?.shapePrimitives?.length){const g=j[j.length-1];g.holes=q.hole.shapePath.shapePrimitives}for(let g=0;g<j.length;g++){const C=j[g];if(!C?.shape)continue;const _=C.transform,E=_&&!_.isIdentity(),X=P.texture&&P.texture!==Ht.WHITE,w=P.textureSpace==="global"?_:null,V=X?ae(Ge,P,C.shape,w):null,M=E?De.copyFrom(o).append(_):o,I=Ue(P,N,V,M);if(E&&(a.save(),a.transform(_.a,_.b,_.c,_.d,_.tx,_.ty)),Z){const R=P;if(R.alignment!==.5&&!R.pixelLine){const Y=[],H=[],S=[];if(re[C.shape.type]?.build(C.shape,Y)){const lt=C.shape.closePath??!0;oe(Y,R,!1,lt,H,S),a.fillStyle=I,Be(a,H,S)}else a.strokeStyle=I,a.beginPath(),it(a,C.shape),a.stroke()}else a.strokeStyle=I,a.beginPath(),it(a,C.shape),a.stroke()}else a.fillStyle=I,a.beginPath(),it(a,C.shape),We(a,C.holes)?a.fill("evenodd"):a.fill();E&&a.restore()}}a.restore()}destroy(){this.shader=null}}Nt.extension={type:[b.CanvasPipesAdaptor],name:"graphics"};class Fe{init(t,e){this._renderer=t,this._renderTargetSystem=e}initGpuRenderTarget(t){const e=t.colorTexture,{canvas:s,context:n}=this._ensureCanvas(e);return{canvas:s,context:n,width:s.width,height:s.height}}resizeGpuRenderTarget(t){const e=t.colorTexture,{canvas:s}=this._ensureCanvas(e);s.width=t.pixelWidth,s.height=t.pixelHeight}startRenderPass(t,e,s,n){const a=this._renderTargetSystem.getGpuRenderTarget(t);this._renderer.canvasContext.activeContext=a.context,this._renderer.canvasContext.activeResolution=t.resolution,e&&this.clear(t,e,s,n)}clear(t,e,s,n){const o=this._renderTargetSystem.getGpuRenderTarget(t).context,i=n||{x:0,y:0,width:t.pixelWidth,height:t.pixelHeight};if(o.setTransform(1,0,0,1,0,0),o.clearRect(i.x,i.y,i.width,i.height),s){const c=Q.shared.setValue(s);c.alpha>0&&(o.globalAlpha=c.alpha,o.fillStyle=c.toHex(),o.fillRect(i.x,i.y,i.width,i.height),o.globalAlpha=1)}}finishRenderPass(){}copyToTexture(t,e,s,n,a){const i=this._renderTargetSystem.getGpuRenderTarget(t).canvas,c=e.source,{context:h}=this._ensureCanvas(c),l=a?.x??0,p=a?.y??0;return h.drawImage(i,s.x,s.y,n.width,n.height,l,p,n.width,n.height),c.update(),e}destroyGpuRenderTarget(t){}_ensureCanvas(t){let e=t.resource;(!e||!le.test(e))&&(e=F.get().createCanvas(t.pixelWidth,t.pixelHeight),t.resource=e),(e.width!==t.pixelWidth||e.height!==t.pixelHeight)&&(e.width=t.pixelWidth,e.height=t.pixelHeight);const s=e.getContext("2d");return{canvas:e,context:s}}}class Yt extends pe{constructor(t){super(t),this.adaptor=new Fe,this.adaptor.init(t,this)}}Yt.extension={type:[b.CanvasSystem],name:"renderTarget"};class zt{constructor(t){}init(){}initSource(t){}generateCanvas(t){const e=F.get().createCanvas(),s=e.getContext("2d"),n=d.getCanvasSource(t);if(!n)return e;const a=t.frame,o=t.source._resolution??t.source.resolution??1,i=a.x*o,c=a.y*o,h=a.width*o,l=a.height*o;return e.width=Math.ceil(h),e.height=Math.ceil(l),s.drawImage(n,i,c,h,l,0,0,h,l),e}getPixels(t){const e=this.generateCanvas(t);return{pixels:e.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,e.width,e.height).data,width:e.width,height:e.height}}destroy(){}}zt.extension={type:[b.CanvasSystem],name:"texture"};const Oe=[...fe,Lt,qt,zt,Yt],Ee=[ge,me,xe,Ce,ye,Vt,Ot,_e],Ve=[Se,Nt],jt=[],Xt=[],$t=[];L.handleByNamedList(b.CanvasSystem,jt);L.handleByNamedList(b.CanvasPipes,Xt);L.handleByNamedList(b.CanvasPipesAdaptor,$t);L.add(...Oe,...Ee,...Ve);class Ye extends he{constructor(){const t={name:"canvas",type:de.CANVAS,systems:jt,renderPipes:Xt,renderPipeAdaptors:$t};super(t)}}export{Ye as CanvasRenderer};
